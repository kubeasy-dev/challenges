apiVersion: v1
kind: ServiceAccount
metadata:
  name: taint-setup
  namespace: tainted-out
  annotations:
    argocd.argoproj.io/sync-wave: "1"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: taint-nodes
  annotations:
    argocd.argoproj.io/sync-wave: "1"
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: taint-setup-binding
  annotations:
    argocd.argoproj.io/sync-wave: "1"
subjects:
  - kind: ServiceAccount
    name: taint-setup
    namespace: tainted-out
roleRef:
  kind: ClusterRole
  name: taint-nodes
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: setup-taint
  namespace: tainted-out
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 60
  template:
    spec:
      serviceAccountName: taint-setup
      restartPolicy: Never
      tolerations:
        - operator: Exists
      containers:
        - name: taint-setup
          image: bitnami/kubectl:1.28
          command:
            - /bin/sh
            - -c
            - |
              echo "Adding taint to worker nodes..."
              for node in $(kubectl get nodes -o name | grep -v control-plane); do
                kubectl taint nodes ${node#node/} dedicated=special:NoSchedule --overwrite || true
                echo "Tainted $node"
              done
              echo "Done"
